name: Build, Test, and Publish Spring Boot Application

on:
  workflow_dispatch:
  push:
    branches:
      - dev
      - tst
      - main
  pull_request:
    branches:
      - dev
      - tst
      - main

jobs:
  build-native-macos:
    needs: build-native
    runs-on: macos-latest
    defaults:
      run:
        working-directory: ${{ github.workspace }}
    steps:
      # Checkout the repository
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Set up JDK 17 with GraalVM
      - name: Set up JDK 17 with GraalVM
        uses: graalvm/setup-graalvm@v1
        with:
          distribution: 'liberica'
          version: '22.3.0'
          java-version: '17'
          cache: 'maven'

      # Install UPX
      - name: Install UPX
        run: brew install upx

      # Get branch name
      - name: Get Branch Name
        id: get_branch
        run: echo "BRANCH_NAME=$(echo ${GITHUB_REF} | awk -F'/' '{print $3}')" >> $GITHUB_ENV

      # Print Java, Maven, and UPX versions
      - name: Print Java, Maven, and UPX Version
        run: |
          echo "GRAALVM_HOME: $GRAALVM_HOME"
          echo "JAVA_HOME: $JAVA_HOME"
          java --version
          native-image --version
          mvn --version
          upx --version

      # Compile to native image
      - name: Compile to Native Image
        run: mvn -Pnative native:compile

      # List target directory contents to verify files
      - name: List Target Directory
        run: ls -l target/

      # Compress the binary using UPX
      - name: Compress Binary with UPX
        run: |
          upx​⬤